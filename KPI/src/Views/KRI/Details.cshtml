@model KPISolution.Models.ViewModels.KPI.KpiDetailsViewModel
@using KPISolution.Models.Enums
@using KPISolution.Extensions
@{
    ViewData["Title"] = Model.Code;
    bool showHistoricalValues = Model.HistoricalValues != null && Model.HistoricalValues.Any();
    bool showLinkedCsfs = Model.LinkedCsfs != null && Model.LinkedCsfs.Any();
    bool showRelatedRIs = Model.RelatedRIs != null && Model.RelatedRIs.Any();
    
    // Prepare chart data
    var chartLabels = new List<string>();
    var chartValues = new List<decimal>();
    var chartTargetValue = "null";
    
    if (Model.HistoricalValues != null && Model.HistoricalValues.Any())
    {
        foreach (var item in Model.HistoricalValues.OrderByDescending(h => h.MeasurementDate))
        {
            chartLabels.Add($"'{item.MeasurementDate.ToString("MM/yyyy")}'");
            chartValues.Add(item.ActualValue);
        }
    }
    
    if (Model.TargetValue.HasValue)
    {
        chartTargetValue = Model.TargetValue.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
    }
    
    var chartLabelsJson = string.Join(",", chartLabels);
    var chartValuesJson = string.Join(",", chartValues);
}

<style>
    .relationship-diagram {
        padding: 1rem;
    }

    .relationship-item {
        display: inline-block;
        max-width: 300px;
        min-width: 200px;
        margin: 0 auto;
    }

    .relationship-arrow {
        font-size: 1.5rem;
        color: #6c757d;
    }

    .relationship-item.active .card {
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }

    .relationship-item.kri-item .card-header {
        background-color: #007bff !important;
    }

    .relationship-item.ri-item .card-header {
        background-color: #17a2b8 !important;
    }

    .relationship-item.pi-item .card-header {
        background-color: #28a745 !important;
    }

    .relationship-item a:hover {
        text-decoration: underline !important;
    }

    /* Animation for the active indicator */
    @@keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }
    
    .relationship-item.active .card {
        animation: pulse 2s infinite;
    }

    .relationship-diagram .card {
        transition: all 0.3s ease;
    }
    
    .relationship-diagram .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.06) !important;
    }
</style>

<div class="container-fluid px-4 pt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a asp-controller="Kri" asp-action="Index">KRI</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Code</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">@Model.Name</h1>
        </div>
        @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
        {
            <div>
                <div class="btn-group">
                    <a asp-controller="Kri" asp-action="AddMeasurement" asp-route-id="@Model.Id" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle me-1"></i>Thêm đo lường
                    </a>
                    <a asp-controller="Kri" asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i>Chỉnh sửa
                    </a>
                    <a asp-controller="Kri" asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>Xóa
                    </a>
                </div>
            </div>
        }
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-1"></i>Thông tin cơ bản
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Mã KRI</p>
                                <p class="mb-0 fw-bold">@Model.Code</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Phòng ban</p>
                                <p class="mb-0 fw-bold">@Model.DepartmentName</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Trạng thái</p>
                                <p class="mb-0">
                                    @switch (Model.Status)
                                    {
                                        case KpiStatus.OnTarget:
                                            <span class="badge bg-success">Đạt mục tiêu</span>
                                            break;
                                        case KpiStatus.AtRisk:
                                            <span class="badge bg-warning text-dark">Có rủi ro</span>
                                            break;
                                        case KpiStatus.BelowTarget:
                                            <span class="badge bg-danger">Không đạt mục tiêu</span>
                                            break;
                                        case KpiStatus.Draft:
                                            <span class="badge bg-secondary">Bản nháp</span>
                                            break;
                                        case KpiStatus.Active:
                                            <span class="badge bg-primary">Hoạt động</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">@Model.Status</span>
                                            break;
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Mục tiêu chiến lược</p>
                                <p class="mb-0 fw-bold">@Model.StrategicObjective</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Lĩnh vực kinh doanh</p>
                                <p class="mb-0 fw-bold">@Model.BusinessAreaDisplay</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Cấp độ tác động</p>
                                <p class="mb-0 fw-bold">@Model.ImpactLevelDisplay</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Người chịu trách nhiệm</p>
                                <p class="mb-0 fw-bold">@Model.Owner</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Người quản lý cấp cao</p>
                                <p class="mb-0 fw-bold">@Model.ExecutiveOwner</p>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Ngày hiệu lực</p>
                                <p class="mb-0 fw-bold">@Model.EffectiveDate.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>

                        <div class="col-12">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Mô tả</p>
                                <p class="mb-0">@Model.Description</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-1"></i>Thông tin đo lường
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Giá trị mục tiêu</p>
                                <p class="mb-0 fw-bold">@Model.TargetValue @Model.Unit</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Giá trị hiện tại</p>
                                <p class="mb-0 fw-bold">
                                    @if (Model.CurrentValue.HasValue)
                                    {
                                        <span>@Model.CurrentValue @Model.Unit</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa có dữ liệu</span>
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Tần suất đo lường</p>
                                <p class="mb-0 fw-bold">@Model.FrequencyString</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Chiều hướng đo lường</p>
                                <p class="mb-0 fw-bold">
                                    @switch (Model.Direction)
                                    {
                                        case MeasurementDirection.HigherIsBetter:
                                            <span>Càng cao càng tốt <i class="bi bi-arrow-up-circle text-success"></i></span>
                                            break;
                                        case MeasurementDirection.LowerIsBetter:
                                            <span>Càng thấp càng tốt <i class="bi bi-arrow-down-circle text-success"></i></span>
                                            break;
                                        case MeasurementDirection.CloserToTarget:
                                            <span>Càng gần mục tiêu càng tốt <i class="bi bi-bullseye text-success"></i></span>
                                            break;
                                        default:
                                            <span>@Model.Direction</span>
                                            break;
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Mức độ tin cậy</p>
                                <p class="mb-0 fw-bold">
                                    @if (Model.ConfidenceLevel.HasValue)
                                    {
                                        <span>@Model.ConfidenceLevel%</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa đánh giá</span>
                                    }
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border-start border-4 border-primary ps-3">
                                <p class="text-muted mb-0 small">Phương pháp tính toán</p>
                                <p class="mb-0 fw-bold">
                                    @if (!string.IsNullOrEmpty(Model.CalculationMethod))
                                    {
                                        <span>@Model.CalculationMethod</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Chưa xác định</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>

                    @if (showHistoricalValues)
                    {
                        <hr class="my-4">
                        <div class="mb-4" style="height: 250px;">
                            <canvas id="historyChart"></canvas>
                        </div>
                        <h6 class="mb-3">Lịch sử đo lường</h6>
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Ngày đo</th>
                                        <th>Giá trị</th>
                                        <th>% đạt mục tiêu</th>
                                        <th>Ghi chú</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var value in Model.HistoricalValues.Take(5)) // Limit to 5 most recent entries
                                    {
                                        <tr>
                                            <td>@value.MeasurementDate.ToString("dd/MM/yyyy")</td>
                                            <td>@value.ActualValue @Model.Unit</td>
                                            <td>
                                                @if (value.AchievementPercentage.HasValue)
                                                {
                                                    <span class="@value.StatusCssClass">
                                                        @value.AchievementPercentage.Value.ToString("0.0")%
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </td>
                                            <td>@(string.IsNullOrEmpty(value.Notes) ? "-" : value.Notes)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                        {
                            <div class="mt-3 text-center">
                                <a asp-controller="Kri" asp-action="AddMeasurement" asp-route-id="@Model.Id"
                                    class="btn btn-sm btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Thêm giá trị đo lường mới
                                </a>
                            </div>
                        }
                    }
                    else
                    {
                        <hr class="my-4">
                        <div class="text-center py-3">
                            <p class="text-muted mb-3">Chưa có dữ liệu đo lường nào được ghi nhận</p>

                            @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                            {
                                <a asp-controller="Kri" asp-action="AddMeasurement" asp-route-id="@Model.Id"
                                    class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i>Thêm giá trị đo lường
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Relationship Diagram -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3 me-1"></i>Mối quan hệ chỉ số
                    </h5>
                    @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                    {
                        <div>
                            <a asp-controller="Ri" asp-action="Create" asp-route-kriId="@Model.Id" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>Thêm RI mới
                            </a>
                        </div>
                    }
                </div>
                <div class="card-body p-0">
                    <div class="p-4 bg-white">
                        <!-- Color Legend -->
                        <div class="d-flex flex-wrap justify-content-center mb-4 border-bottom pb-3">
                            <div class="mx-2 mb-2 d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #ff922b;"></div>
                                <span class="small">KRI (Chỉ số kết quả then chốt)</span>
                            </div>
                            <div class="mx-2 mb-2 d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #4dabf7;"></div>
                                <span class="small">RI (Chỉ số kết quả)</span>
                            </div>
                            <div class="mx-2 mb-2 d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #69db7c;"></div>
                                <span class="small">PI (Chỉ số hiệu suất)</span>
                            </div>
                            <div class="mx-2 mb-2 d-flex align-items-center">
                                <div class="rounded-circle me-2" style="width: 15px; height: 15px; background-color: #ae3ec9;"></div>
                                <span class="small">KPI (Chỉ số hiệu suất then chốt)</span>
                            </div>
                        </div>
                        
                        <div class="relationship-diagram">
                            <!-- Current KRI -->
                            <div class="text-center mb-4">
                                <div class="card border-0 shadow-sm mx-auto" style="max-width: 400px; background-color: #ff922b; color: white;">
                                    <div class="card-body p-3">
                                        <div class="text-uppercase small fw-medium mb-1 opacity-75">Key Result Indicator (KRI) - Hiện tại</div>
                                        <div class="fw-bold fs-5">@Model.Code</div>
                                        <div>@Model.Name</div>
                                    </div>
                                </div>
                            </div>
                            
                            @if (Model.RelatedRIs != null && Model.RelatedRIs.Any())
                            {
                                <div class="text-center mb-3">
                                    <i class="bi bi-arrow-down text-muted fs-3"></i>
                                </div>
                                
                                @foreach (var relatedRi in Model.RelatedRIs)
                                {
                                    <div class="text-center mb-4">
                                        <div class="card border-0 shadow-sm mx-auto" style="max-width: 400px; background-color: #4dabf7; color: white;">
                                            <div class="card-body p-3">
                                                <div class="text-uppercase small fw-medium mb-1 opacity-75">Result Indicator (RI)</div>
                                                <div class="fw-bold fs-5">@relatedRi.Code</div>
                                                <div>@relatedRi.Name</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mb-3">
                                        <i class="bi bi-arrow-down text-muted fs-3"></i>
                                    </div>
                                    
                                    @if (relatedRi.LinkedPIs != null && relatedRi.LinkedPIs.Any())
                                    {
                                        <div class="text-center d-flex flex-wrap justify-content-center">
                                            @foreach (var pi in relatedRi.LinkedPIs)
                                            {
                                                <div class="mx-2 mb-3" style="min-width: 250px; max-width: 300px;">
                                                    @if (pi.KpiType == KpiType.StandaloneKPI)
                                                    {
                                                        <div class="card border-0 shadow-sm" style="background-color: #ae3ec9; color: white;">
                                                            <div class="card-body p-3">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <i class="bi bi-star-fill me-2"></i>
                                                                    <div class="text-uppercase small fw-medium opacity-75">Key Performance Indicator (KPI)</div>
                                                                </div>
                                                                <div class="fw-bold fs-5">@pi.Code</div>
                                                                <div>@pi.Name</div>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="card border-0 shadow-sm" style="background-color: #69db7c; color: white;">
                                                            <div class="card-body p-3">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <i class="bi bi-speedometer2 me-2"></i>
                                                                    <div class="text-uppercase small fw-medium opacity-75">Performance Indicator (PI)</div>
                                                                </div>
                                                                <div class="fw-bold fs-5">@pi.Code</div>
                                                                <div>@pi.Name</div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        
                                        @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                                        {
                                            <div class="text-center mt-3 mb-4">
                                                <a asp-controller="Pi" asp-action="Create" asp-route-riId="@relatedRi.Id" class="btn btn-sm btn-success">
                                                    <i class="bi bi-plus-circle me-1"></i>Thêm PI cho RI này
                                                </a>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="alert alert-info text-center m-3">
                                            Không có PI liên kết với RI này
                                            @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                                            {
                                                <div class="mt-3 mb-4">
                                                    <a asp-controller="Pi" asp-action="Create" asp-route-riId="@relatedRi.Id" class="btn btn-sm btn-success">
                                                        <i class="bi bi-plus-circle me-1"></i>Thêm PI cho RI này
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            }
                            else
                            {
                                <div class="alert alert-info text-center m-3">
                                    Không có RI liên kết với KRI này
                                    @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                                    {
                                        <div class="mt-3">
                                            <a asp-controller="Ri" asp-action="Create" asp-route-kriId="@Model.Id" class="btn btn-sm btn-primary">
                                                <i class="bi bi-plus-circle me-1"></i>Thêm RI mới
                                            </a>
                                        </div>
                                    }
                                </div>
                            }
                            
                            <!-- Direct PIs -->
                            @if (Model.DirectPIs != null && Model.DirectPIs.Any())
                            {
                                <div class="alert alert-primary my-4">
                                    <h6 class="mb-3 text-center fw-bold"><i class="bi bi-link me-1"></i>Các chỉ số hiệu suất (PI) liên kết trực tiếp</h6>
                                    <div class="text-center mb-3">
                                        <i class="bi bi-arrow-down text-muted fs-3"></i>
                                    </div>
                                    <div class="d-flex flex-wrap justify-content-center">
                                        @foreach (var directPi in Model.DirectPIs)
                                        {
                                            <div class="mx-2 mb-3" style="min-width: 250px; max-width: 300px;">
                                                @if (directPi.KpiType == KpiType.StandaloneKPI)
                                                {
                                                    <div class="card border-0 shadow-sm" style="background-color: #ae3ec9; color: white;">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-center mb-2">
                                                                <i class="bi bi-star-fill me-2"></i>
                                                                <div class="text-uppercase small fw-medium opacity-75">Key Performance Indicator (KPI)</div>
                                                            </div>
                                                            <div class="fw-bold fs-5">@directPi.Code</div>
                                                            <div>@directPi.Name</div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="card border-0 shadow-sm" style="background-color: #69db7c; color: white;">
                                                        <div class="card-body p-3">
                                                            <div class="d-flex align-items-center mb-2">
                                                                <i class="bi bi-speedometer2 me-2"></i>
                                                                <div class="text-uppercase small fw-medium opacity-75">Performance Indicator (PI)</div>
                                                            </div>
                                                            <div class="fw-bold fs-5">@directPi.Code</div>
                                                            <div>@directPi.Name</div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Direct PIs section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-speedometer2 me-1"></i>Các chỉ số hiệu suất (PI) trực tiếp
                    </h5>
                    @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                    {
                        <div>
                            <a asp-controller="Pi" asp-action="Create" asp-route-kriId="@Model.Id" class="btn btn-sm btn-success">
                                <i class="bi bi-plus-circle me-1"></i>Thêm PI mới
                            </a>
                        </div>
                    }
                </div>
                <div class="card-body">
                    @if (Model.DirectPIs != null && Model.DirectPIs.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Mã</th>
                                        <th>Tên</th>
                                        <th>Trạng thái</th>
                                        <th>Giá trị mục tiêu</th>
                                        <th>Giá trị hiện tại</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var pi in Model.DirectPIs)
                                    {
                                        <tr>
                                            <td>@pi.Code</td>
                                            <td>@pi.Name</td>
                                            <td>
                                                @if (pi.Status == "OnTarget")
                                                {
                                                    <span class="badge bg-success">Đạt mục tiêu</span>
                                                }
                                                else if (pi.Status == "AtRisk")
                                                {
                                                    <span class="badge bg-warning text-dark">Có rủi ro</span>
                                                }
                                                else if (pi.Status == "BelowTarget")
                                                {
                                                    <span class="badge bg-danger">Không đạt mục tiêu</span>
                                                }
                                                else if (pi.Status == "Draft")
                                                {
                                                    <span class="badge bg-secondary">Bản nháp</span>
                                                }
                                                else if (pi.Status == "Active")
                                                {
                                                    <span class="badge bg-primary">Hoạt động</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">@pi.Status</span>
                                                }
                                            </td>
                                            <td>@pi.TargetValue @pi.Unit</td>
                                            <td>
                                                @if (pi.CurrentValue.HasValue)
                                                {
                                                    <span>@pi.CurrentValue @pi.Unit</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Chưa có dữ liệu</span>
                                                }
                                            </td>
                                            <td>
                                                <a asp-controller="Pi" asp-action="Details" asp-route-id="@pi.Id"
                                                    class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye me-1"></i>Xem
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <p class="text-muted mb-3">Không có PI nào được liên kết trực tiếp với KRI này</p>
                            @if (User.IsInRole("Administrator") || User.IsInRole("Manager"))
                            {
                                <a asp-controller="Pi" asp-action="Create" asp-route-kriId="@Model.Id"
                                    class="btn btn-success">
                                    <i class="bi bi-plus-circle me-1"></i>Thêm PI mới
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (showHistoricalValues)
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var ctx = document.getElementById('historyChart').getContext('2d');
                
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [@Html.Raw(chartLabelsJson)],
                        datasets: [
                            {
                                label: 'Giá trị thực tế',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                                pointBorderColor: '#fff',
                                pointRadius: 5,
                                data: [@chartValuesJson]
                            },
                            {
                                label: 'Giá trị mục tiêu',
                                backgroundColor: 'transparent',
                                borderColor: 'rgba(255, 99, 132, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                data: Array(@chartLabels.Count).fill(@chartTargetValue)
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        }
                    }
                });
            });
        </script>
    }
}