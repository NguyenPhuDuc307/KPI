@model KPISolution.Models.ViewModels.BusinessObjective.BusinessObjectiveEditViewModel

@{
    ViewData["Title"] = "Tạo mục tiêu mới";
    ViewData["Icon"] = "bi-bullseye";
    ViewData["Subtitle"] = "Tạo mới một mục tiêu chiến lược của tổ chức";
}

@section Styles {
    <style>
        select {
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: 38px;
            width: 100%;
            padding: 0.375rem 2.25rem 0.375rem 0.75rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            appearance: none;
        }

        select:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .required:after {
            content: " *";
            color: red;
        }
    </style>
}

<div class="container-fluid px-4">
    <div class="card mb-4 shadow-sm">
        <div class="card-header">
            <i class="bi bi-plus-circle me-1"></i> Thông tin mục tiêu
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label asp-for="Name" class="form-label required">Tên mục tiêu</label>
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Description" class="form-label required">Mô tả</label>
                            <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="BusinessPerspective" class="form-label required">Phối cảnh kinh
                                        doanh</label>
                                    <select name="BusinessPerspective" id="BusinessPerspective">
                                        <option value="1">Tài chính</option>
                                        <option value="2">Khách hàng</option>
                                        <option value="3">Quy trình nội bộ</option>
                                        <option value="4">Học hỏi và phát triển</option>
                                        <option value="5">Khác</option>
                                    </select>
                                    <span asp-validation-for="BusinessPerspective" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Priority" class="form-label required">Mức độ ưu tiên</label>
                                    <select name="Priority" id="Priority">
                                        <option value="1">Thấp</option>
                                        <option value="2">Trung bình</option>
                                        <option value="3">Cao</option>
                                        <option value="4">Quan trọng</option>
                                    </select>
                                    <span asp-validation-for="Priority" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Status" class="form-label required">Trạng thái</label>
                                    <select name="Status" id="Status">
                                        <option value="1">Chưa bắt đầu</option>
                                        <option value="2">Lập kế hoạch</option>
                                        <option value="3">Đang thực hiện</option>
                                        <option value="4">Tạm dừng</option>
                                        <option value="5">Hoàn thành</option>
                                        <option value="6">Đã hủy</option>
                                        <option value="7">Chậm tiến độ</option>
                                        <option value="8">Có rủi ro</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="ProgressPercentage" class="form-label">Tiến độ (%)</label>
                                    <div class="input-group">
                                        <input asp-for="ProgressPercentage" class="form-control" type="number" min="0"
                                            max="100" />
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <span asp-validation-for="ProgressPercentage" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="DepartmentId" class="form-label">Phòng ban phụ trách</label>
                                    <select name="DepartmentId" id="DepartmentId">
                                        <option value="">-- Chọn phòng ban --</option>
                                        @foreach (var item in Model.Departments)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="DepartmentId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Timeframe" class="form-label required">Thời hạn</label>
                                    <select name="Timeframe" id="Timeframe">
                                        <option value="1">Ngắn hạn</option>
                                        <option value="2">Trung hạn</option>
                                        <option value="3">Dài hạn</option>
                                    </select>
                                    <span asp-validation-for="Timeframe" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="StartDate" class="form-label required">Ngày bắt đầu</label>
                                    <input asp-for="StartDate" class="form-control" type="date" />
                                    <span asp-validation-for="StartDate" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="TargetDate" class="form-label required">Ngày hoàn thành dự
                                        kiến</label>
                                    <input asp-for="TargetDate" class="form-control" type="date" />
                                    <span asp-validation-for="TargetDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Budget" class="form-label">Ngân sách</label>
                            <div class="input-group">
                                <span class="input-group-text">VNĐ</span>
                                <input asp-for="Budget" class="form-control" type="number" min="0" step="1000000" />
                            </div>
                            <span asp-validation-for="Budget" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="ParentObjectiveId" class="form-label">Mục tiêu cha</label>
                            <select name="ParentObjectiveId" id="ParentObjectiveId">
                                <option value="">-- Không có mục tiêu cha --</option>
                                @foreach (var item in Model.ParentObjectives)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <span asp-validation-for="ParentObjectiveId" class="text-danger"></span>
                            <small class="text-muted">Nếu mục tiêu này là mục tiêu con của một mục tiêu khác</small>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="FiscalYear" class="form-label">Năm tài chính</label>
                            <input asp-for="FiscalYear" class="form-control" placeholder="Ví dụ: 2023-2024" />
                            <span asp-validation-for="FiscalYear" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Notes" class="form-label">Ghi chú</label>
                            <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="border-top pt-3">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-1"></i> Tạo mục tiêu
                    </button>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i> Hủy bỏ
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        console.log('Script initialization started');
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Document ready');

            // Đảm bảo tất cả select có thể tương tác
            var selects = document.querySelectorAll('select');
            selects.forEach(function (select) {
                // Đảm bảo dropdown có thể mở khi click
                select.addEventListener('mousedown', function (e) {
                    console.log('Select mousedown:', this.id);
                });

                select.addEventListener('click', function (e) {
                    console.log('Select clicked:', this.id);
                });

                select.addEventListener('change', function (e) {
                    console.log('Select changed:', this.id, 'Value:', this.value);
                });
            });

            // Đồng bộ tiến độ và trạng thái
            var progressInput = document.getElementById('ProgressPercentage');
            var statusSelect = document.getElementById('Status');

            progressInput.addEventListener('change', function () {
                var progress = parseInt(this.value || 0);
                console.log('Progress changed to:', progress);

                if (progress === 0) {
                    statusSelect.value = '1'; // Chưa bắt đầu
                    console.log('Set status to Not Started');
                } else if (progress === 100) {
                    statusSelect.value = '5'; // Hoàn thành
                    console.log('Set status to Completed');
                } else if (progress > 0 && progress < 100) {
                    statusSelect.value = '3'; // Đang thực hiện
                    console.log('Set status to In Progress');
                }
            });

            // Kiểm tra ngày
            var startDateInput = document.getElementById('StartDate');
            var targetDateInput = document.getElementById('TargetDate');

            targetDateInput.addEventListener('change', function () {
                console.log('Target date changed');
                var startDate = new Date(startDateInput.value);
                var targetDate = new Date(this.value);

                if (targetDate < startDate) {
                    alert('Ngày hoàn thành dự kiến phải sau ngày bắt đầu!');
                    this.value = startDateInput.value;
                }
            });
        });
    </script>
}