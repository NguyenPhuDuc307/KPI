@model KPISolution.Models.ViewModels.BusinessObjective.BusinessObjectiveDetailsViewModel

@{
    ViewData["Title"] = "Chi tiết mục tiêu";
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mt-4 mb-0"><i class="bi bi-bullseye me-2"></i>Chi tiết mục tiêu</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-controller="BusinessObjective" asp-action="Index">Mục tiêu kinh
                            doanh</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
                </ol>
            </nav>
        </div>
        <div>
            <div class="btn-group">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i> Chỉnh sửa
                </a>
                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Xóa
                </a>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Quay lại
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xl-8">
            <div class="card mb-4 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-1"></i> Thông tin mục tiêu</h5>
                    <span class="@Model.StatusBadgeClass">@Html.DisplayFor(model => model.Status)</span>
                </div>
                <div class="card-body">
                    <h4 class="mb-3">@Model.Name</h4>

                    <div class="mb-4">
                        <p class="text-muted">@Model.Description</p>
                    </div>

                    <div class="progress mb-2" style="height: 20px;">
                        <div class="@Model.ProgressBarClass" role="progressbar"
                            style="width: @Model.ProgressPercentage%;" aria-valuenow="@Model.ProgressPercentage"
                            aria-valuemin="0" aria-valuemax="100">
                            @Model.ProgressPercentage%
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="progress-update-form">
                            <form id="progressUpdateForm" class="row g-2">
                                <input type="hidden" id="objectiveId" value="@Model.Id" />
                                <div class="col-md-8">
                                    <input type="range" class="form-range" id="progressSlider"
                                        value="@Model.ProgressPercentage" min="0" max="100" step="5">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control" id="progressValue"
                                        value="@Model.ProgressPercentage" min="0" max="100">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-primary w-100">Cập nhật</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <hr />

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Thông tin cơ bản</h5>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <th class="text-nowrap" style="width: 40%;">Phối cảnh:</th>
                                    <td>@Model.BusinessPerspectiveDisplayText</td>
                                </tr>
                                <tr>
                                    <th>Phòng ban:</th>
                                    <td>@(string.IsNullOrEmpty(Model.Department) ? "-" : Model.Department)</td>
                                </tr>
                                <tr>
                                    <th>Mức độ ưu tiên:</th>
                                    <td><span class="@Model.PriorityBadgeClass">@Html.DisplayFor(model =>
                                                                                        model.Priority)</span></td>
                                </tr>
                                <tr>
                                    <th>Thời hạn:</th>
                                    <td>@Model.TimeframeDisplayText</td>
                                </tr>
                                <tr>
                                    <th>Năm tài chính:</th>
                                    <td>@(string.IsNullOrEmpty(Model.FiscalYear) ? "-" : Model.FiscalYear)</td>
                                </tr>
                                <tr>
                                    <th>Ngân sách:</th>
                                    <td>@(Model.Budget.HasValue ? string.Format("{0:N0} VNĐ", Model.Budget) : "-")</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Thời gian</h5>
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <th style="width: 40%;">Ngày bắt đầu:</th>
                                    <td>@Model.StartDate.ToString("dd/MM/yyyy")</td>
                                </tr>
                                <tr>
                                    <th>Dự kiến hoàn thành:</th>
                                    <td>@Model.TargetDate.ToString("dd/MM/yyyy")</td>
                                </tr>
                                <tr>
                                    <th>Thời gian còn lại:</th>
                                    <td>
                                        @{
                                            var remainingDays = (Model.TargetDate - DateTime.Today).Days;
                                            var badgeClass = remainingDays < 0 ? "badge bg-danger" : remainingDays < 7 ?
                                            "badge bg-warning text-dark" : "badge bg-success";
                                        }
                                        <span class="@badgeClass">
                                            @(remainingDays < 0 ? "Quá hạn " + Math.Abs(remainingDays) + " ngày" :
                                                                                        remainingDays + " ngày")
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Ngày hoàn thành:</th>
                                    <td>@(Model.CompletionDate.HasValue ?
                                                                                Model.CompletionDate.Value.ToString("dd/MM/yyyy") : "-")</td>
                                </tr>
                                <tr>
                                    <th>Trạng thái:</th>
                                    <td><span class="@Model.StatusBadgeClass">@Html.DisplayFor(model =>
                                                                                        model.Status)</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <div class="mb-4">
                            <h5>Ghi chú</h5>
                            <div class="p-3 bg-light rounded">
                                <p class="mb-0">@Model.Notes</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @if (Model.RelatedCSFs.Any())
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <i class="bi bi-check2-square me-1"></i> Yếu tố thành công quan trọng (CSF)
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Mã</th>
                                        <th>Tên CSF</th>
                                        <th>Trạng thái</th>
                                        <th>Tiến độ</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var csf in Model.RelatedCSFs)
                                    {
                                        <tr>
                                            <td>@csf.Code</td>
                                            <td>@csf.Name</td>
                                            <td><span class="@csf.StatusBadgeClass">@Html.DisplayFor(modelItem =>
                                                                                                csf.Status)</span></td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar @(csf.ProgressPercentage == 100 ? "bg-success" : csf.ProgressPercentage >= 50 ? "bg-primary" : "bg-warning")"
                                                role="progressbar" style="width: @(csf.ProgressPercentage)%;"
                                                aria-valuenow="@csf.ProgressPercentage" aria-valuemin="0"
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small>@csf.ProgressPercentage%</small>
                                    </td>
                                    <td>
                                        <a asp-controller="CSF" asp-action="Details" asp-route-id="@csf.Id"
                                            class="btn btn-sm btn-info">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                                                }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-xl-4">
            @if (Model.ParentObjective != null)
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <i class="bi bi-diagram-2 me-1"></i> Mục tiêu cha
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <span class="badge rounded-pill bg-primary d-flex align-items-center justify-content-center"
                                    style="width: 40px; height: 40px; font-size: 1.2rem;">
                                    <i class="bi bi-bullseye"></i>
                                </span>
                            </div>
                            <div>
                                <h5 class="mb-0">
                                    @if (Model.ParentObjective != null)
                                    {
                                        <a asp-action="Details" asp-route-id="@Model.ParentObjective.Id"
                                            class="text-decoration-none text-dark">
                                            @Model.ParentObjective.Name
                                        </a>
                                    }
                                </h5>
                                @if (Model.ParentObjective != null)
                                {
                                    <span class="@Model.ParentObjective.StatusBadgeClass">@Html.DisplayFor(model =>
                                                                                        model.ParentObjective!.Status)</span>
                                    <span class="ms-2">@Model.ParentObjective.ProgressPercentage%</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            @if (Model.ChildObjectives.Any())
            {
                <div class="card mb-4 shadow-sm">
                    <div class="card-header">
                        <i class="bi bi-diagram-3 me-1"></i> Mục tiêu con (@Model.ChildObjectives.Count)
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            @foreach (var child in Model.ChildObjectives)
                            {
                                <a asp-action="Details" asp-route-id="@child.Id" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h6 class="mb-1">@child.Name</h6>
                                        <span class="@child.StatusBadgeClass">@Html.DisplayFor(modelItem => child.Status)</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small>Hoàn thành: @child.TargetDate.ToString("dd/MM/yyyy")</small>
                                        <div>
                                            <div class="progress" style="width: 100px; height: 8px;">
                                                <div class="progress-bar @(child.ProgressPercentage == 100 ? "bg-success" : child.ProgressPercentage >= 50 ? "bg-primary" : "bg-warning")"
                                                    role="progressbar" style="width: @(child.ProgressPercentage)%;"
                                                    aria-valuenow="@child.ProgressPercentage" aria-valuemin="0"
                                                    aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="text-end d-block">@child.ProgressPercentage%</small>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Sync the slider and number input
            $('#progressSlider').on('input', function () {
                $('#progressValue').val($(this).val());
            });

            $('#progressValue').on('input', function () {
                $('#progressSlider').val($(this).val());
            });

            // Submit progress update
            $('#progressUpdateForm').on('submit', function (e) {
                e.preventDefault();

                var objectiveId = $('#objectiveId').val();
                var progress = $('#progressValue').val();

                $.ajax({
                    url: '@Url.Action("UpdateProgress", "BusinessObjective")',
                    type: 'POST',
                    data: { id: objectiveId, progress: progress },
                    success: function (response) {
                        if (response.success) {
                            toastr.success('Tiến độ đã được cập nhật thành công');
                            setTimeout(function () {
                                location.reload();
                            }, 1000);
                        } else {
                            toastr.error('Có lỗi xảy ra khi cập nhật tiến độ');
                        }
                    },
                    error: function () {
                        toastr.error('Có lỗi xảy ra khi cập nhật tiến độ');
                    }
                });
            });
        });
    </script>
}